@model IEnumerable<EnglishLearning.Models.Lesson>
@{
    ViewData["Title"] = "Danh sách bài học";
    Layout = "~/Areas/Admin/Views/Shared/Temp.cshtml";

    var searchString = ViewBag.SearchString as string ?? "";
    var currentPage = ViewBag.CurrentPage as int? ?? 1;
    var totalPages = ViewBag.TotalPages as int? ?? 1;
}
<style>
    .custom-header {
        background: linear-gradient(90deg, #4b6cb7, #182848) !important;
        color: white !important;
        padding: 15px !important;
        border-radius: 8px !important;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2) !important;
        margin-bottom: 20px !important;
    }

    .custom-btn {
        background: linear-gradient(90deg, #007bff, #0056b3) !important;
        color: white !important;
        border: none !important;
        transition: all 0.3s ease !important;
    }

        .custom-btn:hover {
            transform: translateY(-2px) !important;
            background: linear-gradient(90deg, #0056b3, #003366) !important;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2) !important;
        }

    .custom-table {
        border-radius: 8px !important;
        overflow: hidden !important;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1) !important;
    }

        .custom-table th {
            background: linear-gradient(90deg, #343a40, #212529) !important;
            color: white !important;
        }

        .custom-table tbody tr {
            transition: all 0.3s ease !important;
        }

            .custom-table tbody tr:hover {
                background-color: #f1f1f1 !important;
                transform: scale(1.01) !important;
            }

    .no-data {
        background: #f8f9fa !important;
        padding: 15px !important;
        border-radius: 5px !important;
    }

    .search-form {
        max-width: 400px;
        margin-bottom: 20px;
    }

        .search-form .form-control {
            border-radius: 20px 0 0 20px;
            border: 1px solid #4b6cb7;
            transition: border-color 0.3s ease;
        }

            .search-form .form-control:focus {
                border-color: #007bff;
                box-shadow: 0 0 5px rgba(0, 123, 255, 0.3);
            }

        .search-form .btn-search {
            border-radius: 0 20px 20px 0;
            background: linear-gradient(90deg, #007bff, #0056b3);
            color: white;
            border: none;
        }

            .search-form .btn-search:hover {
                background: linear-gradient(90deg, #0056b3, #003366);
            }
</style>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3 custom-header">
        <h2 class="mb-0"><i class="fa fa-book me-2"></i>@ViewData["Title"]</h2>
        <div>
            <a asp-action="Create" class="btn custom-btn"><i class="fa fa-plus me-2"></i> Thêm bài học</a>
            <a asp-action="CreateToeic" class="btn custom-btn"><i class="fa fa-plus"></i> Thêm đề TOEIC</a>
        </div>
    </div>

    <!-- Form tìm kiếm (giữ giá trị khi phân trang) -->
    <form asp-action="Index" method="get" class="search-form d-flex mb-3">
        <input class="form-control" type="text" name="searchString" placeholder="Tìm kiếm theo tiêu đề hoặc mã..."
               value="@searchString" />
        <input type="hidden" name="page" value="1" />
        <button type="submit" class="btn btn-search"><i class="fa fa-search me-2"></i>Tìm</button>
    </form>

    <!-- Thông báo -->
    @if (TempData["success"] != null)
    {
        <div class="alert alert-success"><i class="fa fa-check-circle me-2"></i>@TempData["success"]</div>
    }
    @if (TempData["error"] != null)
    {
        <div class="alert alert-danger"><i class="fa fa-exclamation-circle me-2"></i>@TempData["error"]</div>
    }

    <!-- Bảng bài học -->
    <table class="table table-striped table-bordered table-hover custom-table">
        <thead>
            <tr>
                <th style="width: 5%;">STT</th>
                <th style="width: 10%;">Mã bài học</th>
                <th style="width: 25%;">Tiêu đề</th>
                <th style="width: 20%;">Khóa học</th>
                <th style="width: 10%;">Thứ tự</th>
                <th style="width: 15%;">Video</th>
                <th style="width: 25%;">Thao tác</th>
            </tr>
        </thead>
        <tbody>
            @if (Model != null && Model.Any())
            {
                int stt = (currentPage - 1) * 10 + 1; // Tính STT đúng theo trang
                foreach (var item in Model)
                {
                    <tr>
                        <td>@stt</td>
                        <td>@item.LessonId</td>
                        <td>@item.Title</td>
                        <td>@item.Course?.Title</td>
                        <td>@item.OrderIndex</td>
                        <td>
                            @if (!string.IsNullOrEmpty(item.VideoUrl))
                            {
                                <a href="@item.VideoUrl" target="_blank" class="text-primary">
                                    <i class="fa fa-video"></i> Xem
                                </a>
                            }
                            else
                            {
                                <span class="text-muted">—</span>
                            }
                        </td>
                        <td>
                            <a asp-action="Edit" asp-route-id="@item.LessonId" class="btn btn-sm btn-warning me-1">
                                <i class="fa fa-edit me-1"></i>Sửa
                            </a>
                            <a asp-action="Delete" asp-route-id="@item.LessonId"
                               onclick="return confirm('Bạn có chắc muốn xóa bài học này không?')"
                               class="btn btn-sm btn-danger">
                                <i class="fa fa-trash me-1"></i>Xóa
                            </a>
                        </td>
                    </tr>
                    stt++;
                }
            }
            else
            {
                <tr>
                    <td colspan="7" class="text-center no-data">
                        <i class="fa fa-info-circle me-2"></i>
                        @(string.IsNullOrEmpty(searchString)
                            ? "Chưa có bài học nào."
                            : "Không tìm thấy bài học nào phù hợp.")
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <!-- PHÂN TRANG -->
    @if (Model.Any())
    {
        <nav aria-label="Page navigation" class="mt-4">
            <ul class="pagination justify-content-center flex-wrap">
                <!-- Trang đầu -->
                <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                    <a class="page-link" href="@Url.Action("Index", new { searchString, page = 1 })">««</a>
                </li>
                <!-- Trang trước -->
                <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                    <a class="page-link" href="@Url.Action("Index", new { searchString, page = currentPage - 1 })">«</a>
                </li>

                @{
                    int startPage = Math.Max(1, currentPage - 2);
                    int endPage = Math.Min(totalPages, currentPage + 2);

                    if (startPage > 1)
                    {
                        <li class="page-item"><a class="page-link" href="@Url.Action("Index", new { searchString, page = 1 })">1</a></li>
                        if (startPage > 2)
                        {
                            <li class="page-item disabled"><span class="page-link">...</span></li>
                        }
                    }

                    for (int i = startPage; i <= endPage; i++)
                    {
                        <li class="page-item @(i == currentPage ? "active" : "")">
                            <a class="page-link" href="@Url.Action("Index", new { searchString, page = i })">@i</a>
                        </li>
                    }

                    if (endPage < totalPages)
                    {
                        if (endPage < totalPages - 1)
                        {
                            <li class="page-item disabled"><span class="page-link">...</span></li>
                        }
                        <li class="page-item"><a class="page-link" href="@Url.Action("Index", new { searchString, page = totalPages })">@totalPages</a></li>
                    }
                }

                <!-- Trang sau -->
                <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                    <a class="page-link" href="@Url.Action("Index", new { searchString, page = currentPage + 1 })">»</a>
                </li>
                <!-- Trang cuối -->
                <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                    <a class="page-link" href="@Url.Action("Index", new { searchString, page = totalPages })">»»</a>
                </li>
            </ul>
        </nav>

        <div class="text-center text-muted small mt-2">
            Trang <strong>@currentPage</strong> / @totalPages
            (@Model.Count() bài học trên trang
            @if (ViewBag.TotalItems > 0)
            {
                <text>| Tổng cộng @ViewBag.TotalItems bài học</text>
            })
        </div>
    }
</div>

<!-- FontAwesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />